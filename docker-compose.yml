services:
  # ─── SQL Server ─────────────────────────────────────────────────
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: smartbooking-db
    environment:
      SA_PASSWORD: "SmartBooking@2024" # Phải có chữ hoa + số + ký tự đặc biệt
      ACCEPT_EULA: "Y"
      MSSQL_PID: "Developer" # Free license cho developer
    ports:
      - "1433:1433" # Cho phép kết nối từ SSMS bên ngoài
    volumes:
      - sqlserver_data:/var/opt/mssql # Persist data khi container restart
    healthcheck:
      test: [
          "CMD",
          "/opt/mssql-tools18/bin/sqlcmd",
          "-S",
          "localhost",
          "-U",
          "sa",
          "-P",
          "SmartBooking@2024",
          "-Q",
          "SELECT 1",
          "-No",
        ] # -No = no SSL validation
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s # SQL Server cần ~30s để khởi động

  # ─── API ────────────────────────────────────────────────────────
  api:
    build:
      context: . # Dockerfile ở root solution
      dockerfile: Dockerfile
    container_name: smartbooking-api
    ports:
      - "8081:8080" # localhost:8080 → container:8080
    environment:
      ASPNETCORE_ENVIRONMENT: "Development"
      ASPNETCORE_URLS: "http://+:8080" # Lắng nghe trên port 8080

      # Override connection string — trỏ vào container sqlserver
      # "sqlserver" = tên service bên trên, Docker tự resolve DNS
      ConnectionStrings__DefaultConnection: >
        Server=sqlserver,1433;
        Database=SmartBookingDb;
        User Id=sa;
        Password=SmartBooking@2024;
        TrustServerCertificate=True;

      # JWT Settings
      JwtSettings__SecretKey: "super-secret-key-smartbooking-2024-change-in-production"
      JwtSettings__Issuer: "SmartBooking"
      JwtSettings__Audience: "SmartBookingUsers"
      JwtSettings__AccessTokenExpirationMinutes: "60"
      JwtSettings__RefreshTokenExpirationDays: "7"

    depends_on:
      sqlserver:
        condition: service_healthy # Chờ SQL Server healthy mới khởi động API
    restart: on-failure # Tự restart nếu crash

volumes:
  sqlserver_data: # Volume persist data SQL Server
